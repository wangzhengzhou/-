<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <meta charset="utf-8">
    <meta name="referrer" content="never">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1054556_g5vx11qepu.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css">
    <title>JS Bin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        a {
            text-decoration: none;
        }

        main {
            padding-top: 12vh;
            height: calc(100% - 25vh);
            overflow: hidden;
        }

        html,
        body,
        section {
            height: 100%;
            overflow: hidden;
        }

        .bg {
            background: url(//cloud.hunger-valley.com/music/public_tuijian_spring.jpg-small) no-repeat;
            background-size: cover;
            z-index: -1;
            position: absolute;
            filter: blur(4px);
            left: -10px;
            top: -10px;
            right: -10px;
            bottom: -10px;
        }

        .bg::before {
            content: "";
            position: absolute;
            left: -10px;
            top: -10px;
            right: -10px;
            bottom: -10px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        #page-cover {
            display: none;
        }

        .win {
            width: 48vh;
            height: 45vh;
            background-image: url(//cloud.hunger-valley.com/music/public_tuijian_spring.jpg-small) ;
            background-size: cover;
        }

        .control {
            font-family: "iconfont";
            margin-left: 10vh;
            float: left;
        }

        main::after {
            content: "";
            display: block;
            clear: both;
        }

        .control span {
            display: inline-block;
            width: calc(33.33% - 1vw);
            text-align: center;
            font-size: 5vh;
            margin-top: 5vh;
            color: #ccc;
            cursor: pointer;
        }

        .control span:hover {
            color: white;
        }

        .title {
            display: inline-block;
            font-size: 2vh;
            min-width: 4em;
            padding: .2em 0.8em;
            background-color: rgb(69, 69, 241);
            color: white;
            text-align: center;
        }

        h1 {
            min-width: 7em;
            font-size: 7vh;
            color: white;
            margin: 5vh 0 10vh 0;
        }

        .infor {
            margin-left: 65vh;
            width: calc(100% - 93vh);
        }

        .infor span {
            font-family: "iconfont";
            font-size: 3vh;
            color: white;
            display: inline-block;
            width: calc(33.33% - 3vw);
        }

        .infor-like {
            margin-bottom: 7vh;
            min-width: 40vh;
        }

        .bar {
            width: 100%;
            min-width: 40vw;
            height: 5vh;
            position: relative;
        }

        .bar-time {
            width: calc(100% - 20vh)
        }

        .time {
            width: 16vh;
            min-width: 3em;
            font-size: .4em;
            line-height: 0.5;
            color: white;
            position: absolute;
            right:-20vh;
        }

        .below {
            width: 100%;
            background-color: #ccc;
            height: 1vh;
            position: absolute;
            top: 0;
            border-radius: 1vh;
        }

        .on {
            background-color: white;
            height: 1vh;
            position: absolute;
            top: 0;
            border-radius: 1vh;
            transition: width 1s
        }

        .song>span {
            display: block;
            min-width: 8vh
        }

        .lyric {
            color: white;
        }

        footer {
            position: relative;
            height: 25vh;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.2);
        }

        footer span {
            font-family: "iconfont";
            font-size: 5vh;
            color: white;
            margin-top: 3vh;
            opacity: 0;
            cursor: pointer;
        }

        .icon-left {
            width: 10vh;
            padding: 5vh;
            position: absolute;
            left: 10vh;
        }

        .icon-right {
            width: 10vh;
            padding: 5vh;
            position: absolute;
            right: 10vh;
        }

        footer span:hover {
            opacity: 1;
        }

        .li {
            margin: 3vh 1vh 5vh;
            text-align: center;
            color: white;
            font-size: 2vh;
            float: left;
            cursor: pointer;
            width: 20vh;
            height: 20vh;
        }

        .form::after {
            content: "";
            display: block;
            clear: both;
        }

        .li>div {
            width: 20vh;
            height: 15vh;
            margin-bottom: 2vh;
            background-size: cover;
        }

        .li:hover {
            box-shadow: 0 0 4px 4px rgba(255, 255, 255, 0.6);
        }
        .li.active{
            box-shadow: 0 0 4px 4px rgba(255, 255, 255, 0.6);
        }

        .table {
            width: 76vw;
            margin: 0 auto;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .form {
            position: absolute;
            top: 0;
        }

        .boomText{
            opacity: 0;
        }
    </style>
</head>

<body>
    <section id="page-music">
        <main>
            <div class="control">
                <div class="win"></div>
                <span class=" btn-collect icon-collect"></span>
                <span class="btn-play icon-play"></span>
                <span class="btn-next icon-next"></span>
            </div>
            <div class="infor">
                <div class="title">90后</div>
                <h1>It's new day</h1>
                <div class="infor-like">
                    <span class="icon-head">3333</span>
                    <span class="icon-collect">128</span>
                    <span class="icon-praise">20</span>
                </div>
                <div class="bar">
                    <div class="bar-time">
                        <div class="below"></div>
                        <div class="on"></div>
                    </div>
                    <div class="time">0：00</div>
                </div>
                <div class="song">
                    <span>黄霄云</span>
                    <div class="lyric"></div>
                </div>
            </div>
        </main>
        <footer>
            <span class="icon-left"></span>
            <span class="icon-right"></span>
            <div class="table">
                <div class="form">
                </div>
            </div>
        </footer>
    </section>
    <section id="page-cover"></section>
    <div class="bg"></div>

    <script>
        var EVentCenter = {
            on: function(type, handler) {
                $(document).on(type, handler)
            },
            fire: function(type, data) {
                $(document).trigger(type, data)
            }
        }

        var Footer = {
            init: function() {
                this.$footer = $('footer')
                this.$form = this.$footer.find('.form')
                this.$table = this.$footer.find('.table')
                this.isToEnd = false
                this.isToStart = true
                this.isAnimate = false
                this.bind()
                this.render()
                //console.log(aWidth)

            },
            bind: function() {
                var _this = this
                _this.$footer.find('.icon-right').click(function() {
                    if(_this.isAnimate)return
                    var num = Math.floor(_this.$table.width() / _this.$footer.find('.li').outerWidth(true))
                    if (!_this.isToEnd) {
                        _this.isAnimate = true
                        _this.$form.animate({
                            left: '-=' + num * _this.$footer.find('.li').outerWidth(true)
                        }, 400, function() {
                            _this.isAnimate = false
                            _this.isToStart = false
                            if (parseFloat(_this.$table.width()) - parseFloat(_this.$form.css('left')) >= _this.$form.outerWidth(true)) {
                                _this.isToEnd = true
                            }
                        })
                    }
                })
                _this.$footer.find('.icon-left').click(function() {
                    if(_this.isAnimate)return
                    var num = Math.floor(_this.$table.width() / _this.$footer.find('.li').outerWidth(true))
                    if (!_this.isToStart) {
                        _this.isAnimate = true
                        _this.$form.animate({
                            left: '+=' + num * _this.$footer.find('.li').outerWidth(true)
                        }, 400, function() {
                            _this.isAnimate = false
                            _this.isToEnd = false
                            if (parseFloat(_this.$form.css('left')) >= 0 ){
                                _this.isToStart = true
                            }
                        })
                    }
                })
                _this.$footer.on('click','.li',function(){
                    $(this).addClass('active').siblings().removeClass('active')
                    EVentCenter.fire('select-albumn',{
                        channelId:$(this).attr('data-channel-id'),
                        channelName:$(this).attr('data-channel-name')
                        })
                })

            },
            render: function() {
                var _this = this
                $.getJSON('//api.jirengu.com/fm/getChannels.php').done(function(data) {
                    _this.renderFooter(data)
                }).fail(function() {
                    console.log('error...')
                })
            },
            renderFooter: function(data) {
                var html = ''
                data.channels.forEach(function(ret) {
                    //console.log(data)
                    html += '<div data-channel-id=' +
                        ret.channel_id + ' data-channel-name=' +
                        ret.name + ' class="li">' +
                        '<div style = "background-image:url(' + ret.cover_small +
                        ')"></div>' + ret.name + '</div>'
                    $('.form').html(html)
                })
                this.setStyle()
                //console.log($node)
                //
            },
            setStyle: function() {
                var count = this.$footer.find('.li').length
                var aWidth = this.$footer.find('.li').outerWidth(true)
                this.$form.css({
                    width: count * aWidth
                })
            }
        }

        var Fm = {
            init:function(){
                this.audio = new Audio()
                this.audio.autoplay = true
                this.$section = $('#page-music')
                this.loadMusic(function(){
                        this.setMusic()
                    })
                this.bind()
            },
            bind:function(){
                var _this = this
                EVentCenter.on('select-albumn',function(e,channelObj){
                    _this.channelId = channelObj.channelId
                    _this.channelName = channelObj.channelName
                    //console.log(channelId)
                    _this.loadMusic()
                })
                this.$section.find('.btn-play').click(function(){
                    var $btn = $(this)
                    if($btn.hasClass('icon-play')){
                        $btn.removeClass('icon-play').addClass('icon-pause')
                        _this.audio.pause()
                    }else{
                        $btn.removeClass('icon-pause').addClass('icon-play')
                        _this.audio.play()
                    }
                })
                this.$section.find('.btn-next').click(function(){
                    _this.$section.find('.lyric').text('')
                    _this.$section.find('.song span').text('')
                    _this.loadMusic(function(){
                        _this.setMusic()
                    })
                })
                this.audio.addEventListener('play',function(){
                    clearInterval( _this.statusClock)
                    //console.log('play')
                    _this.statusClock = setInterval(function(){
                        _this.updateStatus()
                    },1000)
                })
                this.audio.addEventListener('pause',function(){
                    clearInterval( _this.statusClock)
                    //console.log('pause')
                })
                this.$section.find('.bar-time').click(function(e) {
                    var percent = e.offsetX / parseFloat(_this.$section.find('.below').width())
                    _this.audio.currentTime = _this.audio.duration * percent
                })

            },
            loadMusic:function(){
                var _this = this
                $.getJSON('//jirenguapi.applinzi.com/fm/getSong.php',{channel:this.channelId}).done(function(ret){
                    _this.song = ret['song'][0]
                    _this.setMusic()
                    _this.loadLyric()
                })
            },

            loadLyric:function(){
                var _this = this
                $.getJSON('//jirenguapi.applinzi.com/fm/getLyric.php',{sid:this.song.sid}).done(function(ret){
                    var lyric = ret.lyric
                    var lyricObj = {}
                    lyric.split('\n').forEach(function(line){//得到的歌词对象转化成数组
                        var times = line.match(/\d{2}:\d{2}/g)//得到其中包含分秒的时间
                        var str = line.replace(/\[.+?\]/g,'')//将时间替换为空字符串，得到歌词内容
                        if(Array.isArray(times)){
                            times.forEach(function(time){
                                lyricObj[time] = str//如果拆解成数组后得到的分秒事件不为空，将时间作为key,歌词内容作为value形成一个新对象
                            })
                        }
                    })
                    _this.lyricObj = lyricObj
                })
            },

            setMusic:function(){
                $('.btn-play').removeClass('icon-pause').addClass('icon-play')
                this.audio.play()
                //console.log(this)
                this.audio.src = this.song.url
                $('.bg').css('background-image','url('+this.song.picture+')')
                this.$section.find('.win').css('background-image','url('+this.song.picture+')')
                this.$section.find('.title').text(this.channelName)
                this.$section.find('h1').text(this.song.title)
                this.$section.find('.song span').text(this.song.artist)
            },
            updateStatus:function(){
                var _this = this
                var min = Math.floor(this.audio.currentTime/60)
                var second =  Math.floor(this.audio.currentTime%60) + ''//转化成字符串，才能有长度
                //console.log(second.length)
                second = second.length === 2? second:'0' + second
                this.$section.find('.time').text(min + ':' + second)
                this.$section.find('.on').css('width',this.audio.currentTime/this.audio.duration*100 + '%')
                var line = this.lyricObj['0' + min + ':' + second]
                if(line){
                    _this.$section.find('.lyric').text(line).boomText()
                }
            }
        }

        $.fn.boomText = function(type){//jQuery插件，实现动画效果
            type = type||'rollIn'
            this.html(function(){
                var arr = $(this).text()
                .split('').map(function(word){
                    return '<p class="boomText" style="display:inline-block">'+word+'</p>'
                })
                return arr.join('')
            })
            var index = 0
            var $boomTexts = $(this).find('p')
            var clock = setInterval(function(){
                $boomTexts.eq(index).addClass('animated ' + type)
                index++
                if(index>=$boomTexts.length){
                    clearInterval(clock)
                }
            },300)
        }

        Footer.init()
        Fm.init()


    </script>
</body>

</html>
